{% extends 'base.html' %}
{% load static humanize %}
{% block title %}{{newspaper.title}}{% endblock title %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_head %}

{% block main %}
{% comment %} article detail page {% endcomment %}
<section class="space-y-6">
    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Newspaper</p>
                <h1 class="mt-2 text-3xl font-semibold text-slate-900">{{ newspaper.title }}</h1>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm">
                {% if newspaper.link %}
                <a class="rounded-full border border-slate-300 px-3 py-1 text-slate-700 transition hover:border-brand-500 hover:text-brand-700" href="{{ newspaper.link }}" target="_blank" rel="noopener noreferrer">üîó Source</a>
                {% endif %}
                {% if user.is_staff %}
                <a class="rounded-full bg-slate-100 px-3 py-1 text-slate-700 transition hover:bg-slate-200" href="{% url 'admin:main_app_newspaper_change' newspaper.id %}" target="_blank" rel="noopener noreferrer">‚úèÔ∏è Edit in admin</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-6">
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-sky-50 to-sky-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Articles</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ article_count|intcomma }}</h4>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-emerald-50 to-emerald-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Words</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ word_count|intcomma }}</h4>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-amber-50 to-amber-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Annotated names</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ name_stats.counts.total|intcomma }}</h4>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-teal-50 to-teal-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Toponyms</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ name_stats.counts.toponym|intcomma }}</h4>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-violet-50 to-violet-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">TTR</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ text_stats.ttr|floatformat:3 }}</h4>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-rose-50 to-rose-100 p-4 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Hapax</p>
                <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ text_stats.hapax_count|intcomma }}</h4>
            </div>
        </div>
        <div class="mt-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Distribution</p>
                    <h3 class="mt-2 text-lg font-semibold text-slate-900">Top frequency chart</h3>
                </div>
                <div class="flex items-center gap-3 rounded-full border border-slate-300 bg-slate-50 px-4 py-2 text-sm">
                    <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Dataset</span>
                    <label class="flex items-center gap-1 text-slate-700">
                        <input type="radio" id="dataset-words" name="dataset" value="words" checked class="accent-brand-500">
                        Words
                    </label>
                    <label class="flex items-center gap-1 text-slate-700">
                        <input type="radio" id="dataset-names" name="dataset" value="names" class="accent-brand-500">
                        Names
                    </label>
                    <label class="flex items-center gap-1 text-slate-700">
                        <input type="radio" id="dataset-toponyms" name="dataset" value="toponyms" class="accent-brand-500">
                        Toponyms
                    </label>
                </div>
            </div>
            <div class="mt-6">
                <canvas id="word-frequency-chart" class="max-h-[420px]"></canvas>
            </div>
        </div>
    </div>
    <script>
    const url = "{% url 'newspaper_frequency' newspaper_id=newspaper.id %}";
    const ctx = document.getElementById("word-frequency-chart").getContext("2d");
    const datasetRadios = document.getElementsByName('dataset');

    let chart;
    let chartData;
    let currentMetric = 'words';

    const tooltipCallback = (context) => {
        const value = context.parsed.y;
        const total = context.dataset.totalCount || 0;
        const pct = total ? ((value / total) * 100).toFixed(2) : '0.00';
        return `${context.label}: ${value} (${pct}%)`;
    };

    const chartOptions = (showLegend) => ({
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: {
            legend: { display: showLegend },
            tooltip: {
                callbacks: {
                    label: tooltipCallback,
                    footer: () => 'Top-slice total shown; full CSV has more.'
                }
            }
        }
    });

    const buildChartConfig = (metric) => {
        if (metric === 'words') {
            const words = chartData.words || [];
            const total = words.reduce((acc, cur) => acc + (cur.count || 0), 0);
            return {
                labels: words.map(item => item.word),
                datasets: [
                    {
                        label: `Top ${words.length} words (total ${total})`,
                        data: words.map(item => item.count),
                        backgroundColor: "rgba(255, 99, 132, 0.2)",
                        borderColor: "rgba(255, 99, 132, 1)",
                        borderWidth: 1,
                        totalCount: total,
                    },
                ],
                legend: false,
            };
        }

        if (metric === 'names') {
            const names = (chartData.names && chartData.names.frequency) || [];
            const counts = (chartData.names && chartData.names.counts) || {};
            const labels = names.map(item => item.name);
            const maleData = names.map(item => item.gender === 'male' ? item.count : 0);
            const femaleData = names.map(item => item.gender === 'female' ? item.count : 0);
            const maleTotal = counts.male ?? maleData.reduce((acc, cur) => acc + cur, 0);
            const femaleTotal = counts.female ?? femaleData.reduce((acc, cur) => acc + cur, 0);

            return {
                labels,
                datasets: [
                    {
                        label: `Male names (total ${maleTotal})`,
                        data: maleData,
                        backgroundColor: "rgba(75, 192, 192, 0.3)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1,
                        totalCount: maleTotal,
                    },
                    {
                        label: `Female names (total ${femaleTotal})`,
                        data: femaleData,
                        backgroundColor: "rgba(153, 102, 255, 0.3)",
                        borderColor: "rgba(153, 102, 255, 1)",
                        borderWidth: 1,
                        totalCount: femaleTotal,
                    },
                ],
                legend: true,
            };
        }

        if (metric === 'toponyms') {
            const toponyms = (chartData.toponyms && chartData.toponyms.frequency) || [];
            const counts = (chartData.toponyms && chartData.toponyms.counts) || {};
            const total = counts.toponym ?? toponyms.reduce((acc, cur) => acc + (cur.count || 0), 0);

            return {
                labels: toponyms.map(item => item.name),
                datasets: [
                    {
                        label: `Toponyms (total ${total})`,
                        data: toponyms.map(item => item.count),
                        backgroundColor: "rgba(34, 197, 94, 0.25)",
                        borderColor: "rgba(22, 163, 74, 1)",
                        borderWidth: 1,
                        totalCount: total,
                    },
                ],
                legend: false,
            };
        }

        return { labels: [], datasets: [], legend: false };
    };

    const updateChart = () => {
        const config = buildChartConfig(currentMetric);
        chart.data.labels = config.labels;
        chart.data.datasets = config.datasets;
        chart.options.plugins.legend.display = config.legend;
        chart.update();
    };

    fetch(url)
        .then(response => response.json())
        .then(data => {
            chartData = data;
            const initialConfig = buildChartConfig(currentMetric);
            chart = new Chart(ctx, {
                type: "bar",
                data: { labels: initialConfig.labels, datasets: initialConfig.datasets },
                options: chartOptions(initialConfig.legend),
            });

            datasetRadios.forEach(radio => radio.addEventListener('change', (event) => {
                currentMetric = event.target.value;
                updateChart();
            }));
        })
        .catch(() => {
            console.error('Failed to load chart data');
        });
    </script>

    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold text-slate-900">All articles</h2>
            <p class="text-sm text-slate-600">{{ article_count|intcomma }} total</p>
        </div>
        <div class="mt-6 grid gap-4 md:grid-cols-2">
            {% for article in newspaper.article_set.all %}
            <article class="flex h-full flex-col rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <h3 class="text-lg font-semibold text-slate-900">
                    <a title="Go to full article page" href="{% url 'article_detail' article_id=article.pk %}" rel="noopener noreferrer" class="transition hover:text-brand-400">{{ article.title }}</a>
                </h3>
                <p class="mt-1 text-xs uppercase tracking-[0.2em] text-slate-500">{{ article.get_language_display }}</p>
                {% if forloop.first %}
                <p class="mt-3 text-sm text-slate-700" data-gender-annotations>{{ article.content|truncatewords:80 }}</p>
                {% else %}
                <p class="mt-3 text-sm text-slate-700" data-gender-annotations>{{ article.content|truncatewords:20 }}</p>
                {% endif %}
                <div class="mt-4 text-xs text-slate-600">
                    <span><i> By {{ article.author|truncatewords:2 }}</i>, </span>
                    <span>in <a href="{% url 'year_archive' year=article.published_year %}" class="text-slate-700 transition hover:text-brand-700">{{ article.published_year }}</a></span>
                    {% if article.link %}
                    <span> ¬∑ <a class="text-slate-700 transition hover:text-brand-700" href="{{ article.link }}" target="_blank" rel="noopener noreferrer">üîó Source</a></span>
                    {% endif %}
                </div>
            </article>
            {% endfor %}
        </div>
    </div>
</section>
{% endblock main %}