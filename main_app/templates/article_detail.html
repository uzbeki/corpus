{% extends 'base.html' %}
{% block title %}{{article.title}}{% endblock title %}
{% load static humanize %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_head %}

{% block main %}
<article class="space-y-6">
    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Article</p>
                <h1 class="mt-2 text-3xl font-semibold text-slate-900">{{ article.title }}</h1>
            </div>
            <div class="flex flex-wrap items-center gap-2 text-sm">
                {% if article.link %}
                <a class="rounded-full border border-slate-300 px-3 py-1 text-slate-700 transition hover:border-brand-500 hover:text-brand-700" href="{{ article.link }}" target="_blank" rel="noopener noreferrer">üîó Source</a>
                {% endif %}
                {% if user.is_staff %}
                <a class="rounded-full bg-slate-100 px-3 py-1 text-slate-700 transition hover:bg-slate-200" href="{% url 'admin:main_app_article_change' article.id %}" target="_blank" rel="noopener noreferrer">‚úèÔ∏è Edit in admin</a>
                {% endif %}
            </div>
        </div>
        <div class="mt-4 flex flex-wrap items-center gap-3 text-sm text-slate-600">
            <span><i> By {{ article.author|truncatewords:5 }}</i></span>
            <span>‚Ä¢</span>
            <span>in <a href="{% url 'year_archive' year=article.published_year %}" class="text-slate-700 transition hover:text-brand-700">{{ article.published_year }}</a></span>
        </div>
    </div>

    <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
        <div class="name-counts mb-4 text-sm text-slate-600" id="gender-name-counts"></div>
        <div class="space-y-4 text-base leading-7 text-slate-700" data-gender-annotations data-gender-count-target="#gender-name-counts">{{ article.content|linebreaks }}</div>
    </div>
{% comment %} <pre>{{word_frequency}}</pre> {% endcomment %}
<section class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-5">
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Total words</p>
            <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ word_count|intcomma }}</h4>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Unique words</p>
            <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ word_frequency|length }}</h4>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Annotated names</p>
            <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ name_stats.counts.male|add:name_stats.counts.female }}</h4>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-500">TTR</p>
            <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ text_stats.ttr|floatformat:3 }}</h4>
        </div>
        <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Hapax</p>
            <h4 class="mt-3 text-2xl font-semibold text-slate-900">{{ text_stats.hapax_count|intcomma }}</h4>
        </div>
    </div>
    <div class="mt-8">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Distribution</p>
                <h3 class="mt-2 text-lg font-semibold text-slate-900">Top frequency chart</h3>
            </div>
            <div class="flex items-center gap-3 rounded-full border border-slate-300 bg-slate-50 px-4 py-2 text-sm">
                <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Dataset</span>
                <label class="flex items-center gap-1 text-slate-700">
                    <input type="radio" id="dataset-words" name="dataset" value="words" checked class="accent-brand-500">
                    Words
                </label>
                <label class="flex items-center gap-1 text-slate-700">
                    <input type="radio" id="dataset-names" name="dataset" value="names" class="accent-brand-500">
                    Names
                </label>
            </div>
        </div>
        <div class="mt-6">
            <canvas id="word-frequency-chart" class="max-h-[420px]"></canvas>
        </div>
    </div>
    <script>
    const url = "{% url 'article_frequency' article_id=article.id %}";
    const ctx = document.getElementById("word-frequency-chart").getContext("2d");
    const datasetRadios = document.getElementsByName('dataset');

    let chart;
    let chartData;
    let currentMetric = 'words';

    const tooltipCallback = (context) => {
        const value = context.parsed.y;
        const total = context.dataset.totalCount || 0;
        const pct = total ? ((value / total) * 100).toFixed(2) : '0.00';
        return `${context.label}: ${value} (${pct}%)`;
    };

    const chartOptions = (showLegend) => ({
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: {
            legend: { display: showLegend },
            tooltip: {
                callbacks: {
                    label: tooltipCallback,
                    footer: () => 'Top-slice total shown; full CSV has more.'
                }
            }
        }
    });

    const buildChartConfig = (metric) => {
        if (metric === 'words') {
            const words = chartData.words || [];
            const total = words.reduce((acc, cur) => acc + (cur.count || 0), 0);
            return {
                labels: words.map(item => item.word),
                datasets: [
                    {
                        label: `Top ${words.length} words (total ${total})`,
                        data: words.map(item => item.count),
                        backgroundColor: "rgba(255, 99, 132, 0.2)",
                        borderColor: "rgba(255, 99, 132, 1)",
                        borderWidth: 1,
                        totalCount: total,
                    },
                ],
                legend: false,
            };
        }

        if (metric === 'names') {
            const names = (chartData.names && chartData.names.frequency) || [];
            const counts = (chartData.names && chartData.names.counts) || {};
            const labels = names.map(item => item.name);
            const maleData = names.map(item => item.gender === 'male' ? item.count : 0);
            const femaleData = names.map(item => item.gender === 'female' ? item.count : 0);
            const maleTotal = counts.male ?? maleData.reduce((acc, cur) => acc + cur, 0);
            const femaleTotal = counts.female ?? femaleData.reduce((acc, cur) => acc + cur, 0);

            return {
                labels,
                datasets: [
                    {
                        label: `Male names (total ${maleTotal})`,
                        data: maleData,
                        backgroundColor: "rgba(75, 192, 192, 0.3)",
                        borderColor: "rgba(75, 192, 192, 1)",
                        borderWidth: 1,
                        totalCount: maleTotal,
                    },
                    {
                        label: `Female names (total ${femaleTotal})`,
                        data: femaleData,
                        backgroundColor: "rgba(153, 102, 255, 0.3)",
                        borderColor: "rgba(153, 102, 255, 1)",
                        borderWidth: 1,
                        totalCount: femaleTotal,
                    },
                ],
                legend: true,
            };
        }

        return { labels: [], datasets: [], legend: false };
    };

    const updateChart = () => {
        const config = buildChartConfig(currentMetric);
        chart.data.labels = config.labels;
        chart.data.datasets = config.datasets;
        chart.options.plugins.legend.display = config.legend;
        chart.update();
    };

    fetch(url)
        .then(response => response.json())
        .then(data => {
            chartData = data;
            const initialConfig = buildChartConfig(currentMetric);
            chart = new Chart(ctx, {
                type: "bar",
                data: { labels: initialConfig.labels, datasets: initialConfig.datasets },
                options: chartOptions(initialConfig.legend),
            });

            datasetRadios.forEach(radio => radio.addEventListener('change', (event) => {
                currentMetric = event.target.value;
                updateChart();
            }));
        })
        .catch(() => {
            console.error('Failed to load chart data');
        });
    </script>

</section>
{% endblock main %}