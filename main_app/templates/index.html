{% extends 'base.html' %}
{% load static humanize custom_tags %}
{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock extra_head %}

{% block main %}
    <section class="space-y-10">
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
            <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-sky-50 to-sky-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Newspapers</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ newspapers|length }}" data-format="int">{{ newspapers|length }}</h4>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-emerald-50 to-emerald-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Articles</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ article_count }}" data-format="int">{{ article_count|intcomma }}</h4>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-indigo-50 to-indigo-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Words (non-unique)</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ word_count }}" data-format="int">{{ word_count|intcomma }}</h4>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-amber-50 to-amber-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Annotated names</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ name_counts.total }}" data-format="int">{{ name_counts.total|intcomma }}</h4>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-violet-50 to-violet-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">TTR</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ text_stats.ttr }}" data-format="float:3">{{ text_stats.ttr|floatformat:3 }}</h4>
                </div>
                <div class="rounded-2xl border border-slate-200 bg-gradient-to-br from-white via-rose-50 to-rose-100 p-4 shadow-soft">
                    <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Hapax</p>
                    <h4 class="stat-count mt-3 text-2xl font-semibold text-slate-900" data-count="{{ text_stats.hapax_count }}" data-format="int">{{ text_stats.hapax_count|intcomma }}</h4>
                </div>
            </div>
        </div>
        <div class="grid gap-6 lg:grid-cols-[1.3fr_0.7fr]">
            <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div>
                        <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Insight</p>
                        <h2 class="mt-2 text-xl font-semibold text-slate-900">Top frequency overview</h2>
                    </div>
                    <div class="flex flex-wrap items-center gap-4">
                        <div class="flex items-center gap-2 rounded-full border border-slate-300 bg-slate-50 px-3 py-2 text-sm">
                            <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Language</span>
                            <label class="flex items-center gap-1 text-slate-700">
                                <input type="radio" id="english" name="language" value="english" checked class="accent-brand-500">
                                English
                            </label>
                            <label class="flex items-center gap-1 text-slate-700">
                                <input type="radio" id="uzbek" name="language" value="uzbek" class="accent-brand-500">
                                Uzbek
                            </label>
                        </div>
                        <div class="flex items-center gap-2 rounded-full border border-slate-300 bg-slate-50 px-3 py-2 text-sm">
                            <span class="text-xs uppercase tracking-[0.2em] text-slate-500">Dataset</span>
                            <label class="flex items-center gap-1 text-slate-700">
                                <input type="radio" id="dataset-words" name="dataset" value="words" checked class="accent-brand-500">
                                Words
                            </label>
                            <label class="flex items-center gap-1 text-slate-700">
                                <input type="radio" id="dataset-names" name="dataset" value="names" class="accent-brand-500">
                                Names
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <canvas id="word-frequency-chart" class="max-h-[420px]"></canvas>
                </div>
                <div id="download" class="mt-6 flex items-center justify-between">
                    <p class="text-sm text-slate-600">CSV export available for the selected dataset.</p>
                    <button type="button" class="rounded-full bg-brand-600 px-4 py-2 text-sm font-semibold text-white shadow-soft transition hover:bg-brand-500">download full dataset</button>
                </div>
            </div>
            <div class="rounded-3xl border border-slate-200 bg-gradient-to-br from-white via-brand-50 to-brand-100 p-6 shadow-soft">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-500">Explore</p>
                <h3 class="mt-2 text-xl font-semibold text-slate-900">Browse by year</h3>
                <p class="mt-2 text-sm text-slate-600">Jump into a specific year to explore article stats, lexical frequency, and annotated names.</p>
                <div class="mt-4 flex flex-wrap gap-2">
                    {% for year in published_years %}
                        <a href="{% url 'year_archive' year=year %}" class="rounded-full border border-slate-300 px-3 py-1 text-sm text-slate-700 transition hover:border-brand-500 hover:text-brand-700">{{ year }}</a>
                    {% endfor %}
                </div>
            </div>
        </div>
        <script>
        const url = "{% url 'word_frequency_data' %}";
        const ctx = document.getElementById("word-frequency-chart").getContext("2d");
        const languageRadios = document.getElementsByName('language');
        const datasetRadios = document.getElementsByName('dataset');
        const fullDownloadBtn = document.querySelector("#download button");

        let chart;
        let chartData;
        let currentLanguage = 'english';
        let currentMetric = 'words';

        const tooltipCallback = (context) => {
            const value = context.parsed.y;
            const total = context.dataset.totalCount || 0;
            const pct = total ? ((value / total) * 100).toFixed(2) : '0.00';
            return `${context.label}: ${value} (${pct}%)`;
        };

        const chartOptions = (showLegend) => ({
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: {
                legend: { display: showLegend },
                tooltip: {
                    callbacks: {
                        label: tooltipCallback,
                        footer: () => 'Top-slice total shown; full CSV has more.'
                    }
                }
            }
        });

        const buildChartConfig = (language, metric) => {
            const langData = chartData[language] || {};

            if (metric === 'words') {
                const words = langData.words || [];
                const total = words.reduce((acc, cur) => acc + (cur.count || 0), 0);
                return {
                    labels: words.map(item => item.word),
                    datasets: [
                        {
                            label: `Top ${words.length} words (total ${total})`,
                            data: words.map(item => item.count),
                            backgroundColor: "rgba(255, 99, 132, 0.2)",
                            borderColor: "rgba(255, 99, 132, 1)",
                            borderWidth: 1,
                            totalCount: total,
                        },
                    ],
                    legend: false,
                };
            }

            if (metric === 'names') {
                const names = (langData.names && langData.names.frequency) || [];
                const counts = (langData.names && langData.names.counts) || {};
                const labels = names.map(item => item.name);
                const maleData = names.map(item => item.gender === 'male' ? item.count : 0);
                const femaleData = names.map(item => item.gender === 'female' ? item.count : 0);
                const maleTotal = counts.male ?? maleData.reduce((acc, cur) => acc + cur, 0);
                const femaleTotal = counts.female ?? femaleData.reduce((acc, cur) => acc + cur, 0);

                return {
                    labels,
                    datasets: [
                        {
                            label: `Male names (total ${maleTotal})`,
                            data: maleData,
                            backgroundColor: "rgba(75, 192, 192, 0.3)",
                            borderColor: "rgba(75, 192, 192, 1)",
                            borderWidth: 1,
                            totalCount: maleTotal,
                        },
                        {
                            label: `Female names (total ${femaleTotal})`,
                            data: femaleData,
                            backgroundColor: "rgba(153, 102, 255, 0.3)",
                            borderColor: "rgba(153, 102, 255, 1)",
                            borderWidth: 1,
                            totalCount: femaleTotal,
                        },
                    ],
                    legend: true,
                };
            }

            return { labels: [], datasets: [], legend: false };
        };

        const updateDownloadState = () => {
            const label = currentMetric === 'names'
                ? 'download full annotated names'
                : 'download full word frequency';
            fullDownloadBtn.disabled = false;
            fullDownloadBtn.textContent = label;
        };

        const updateChart = () => {
            const config = buildChartConfig(currentLanguage, currentMetric);
            chart.data.labels = config.labels;
            chart.data.datasets = config.datasets;
            chart.options.plugins.legend.display = config.legend;
            chart.update();
            updateDownloadState();
        };

        fetch(url)
            .then(response => response.json())
            .then(data => {
                chartData = data;
                const initialConfig = buildChartConfig(currentLanguage, currentMetric);
                chart = new Chart(ctx, {
                    type: "bar",
                    data: { labels: initialConfig.labels, datasets: initialConfig.datasets },
                    options: chartOptions(initialConfig.legend),
                });

                languageRadios.forEach(radio => radio.addEventListener('change', (event) => {
                    currentLanguage = event.target.value;
                    updateChart();
                }));

                datasetRadios.forEach(radio => radio.addEventListener('change', (event) => {
                    currentMetric = event.target.value;
                    updateChart();
                }));

                updateDownloadState();
            })
            .catch(() => {
                console.error('Failed to load chart data');
            })
            .then(() => {
                fullDownloadBtn.addEventListener('click', () => {
                    const downloadUrl = "{% url 'word_frequency_data' %}?full=1&language="
                        + currentLanguage + "&dataset=" + currentMetric;
                    fetch(downloadUrl)
                        .then(response => response.blob())
                        .then(blob => {
                            if (!blob.size) return;
                            const blobUrl = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = blobUrl;
                            const label = currentMetric === 'names' ? 'annotated_names' : 'word_frequency';
                            a.download = `${label}_${currentLanguage}_${Date.now()}.csv`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(blobUrl);
                        })
                        .catch(() => alert('oh no!'));
                });
            });

        const statCounters = Array.from(document.querySelectorAll('.stat-count'));
        const prefersReducedMotion = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        const formatNumber = (value, format) => {
            if (format && format.startsWith('float:')) {
                const decimals = parseInt(format.split(':')[1], 10) || 0;
                return value.toFixed(decimals);
            }
            return Math.round(value).toLocaleString();
        };

        const animateCounter = (el) => {
            const raw = parseFloat(el.dataset.count || '0');
            if (!Number.isFinite(raw)) return;

            const format = el.dataset.format || 'int';
            if (prefersReducedMotion) {
                el.textContent = formatNumber(raw, format);
                return;
            }

            const duration = 2000;
            const start = performance.now();
            const startValue = 0;
            const delta = raw - startValue;

            const tick = (now) => {
                const progress = Math.min((now - start) / duration, 1);
                const eased = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                const currentValue = startValue + delta * eased;
                el.textContent = formatNumber(currentValue, format);
                if (progress < 1) {
                    requestAnimationFrame(tick);
                }
            };

            requestAnimationFrame(tick);
        };

        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (!entry.isIntersecting) return;
                    animateCounter(entry.target);
                    obs.unobserve(entry.target);
                });
            }, { threshold: 0.4 });

            statCounters.forEach(el => observer.observe(el));
        } else {
            statCounters.forEach(animateCounter);
        }
        </script>

    </section>
    <section class="mt-12 space-y-6">
        <div class="flex items-center justify-between">
            <h2 class="text-2xl font-semibold text-slate-900">Featured newspapers</h2>
            <p class="text-sm text-slate-600">Highlights from each publication.</p>
        </div>
        {% for newspaper in newspapers %}
        <div class="rounded-3xl border border-slate-200 bg-white p-6 shadow-soft">
            <div class="flex flex-wrap items-center justify-between gap-3">
                <h3 class="text-xl font-semibold text-slate-900">
                    <a class="transition hover:text-brand-400" href="{% url 'newspaper_detail' newspaper_id=newspaper.id %}">{{ newspaper.title }}</a>
                </h3>
                {% if newspaper.link %}
                <a class="rounded-full border border-slate-300 px-3 py-1 text-sm text-slate-700 transition hover:border-brand-500 hover:text-brand-700" href="{{ newspaper.link }}" target="_blank" rel="noopener noreferrer">ðŸ”— Source</a>
                {% endif %}
            </div>
            <div class="mt-6 grid gap-4 md:grid-cols-3">
                {% for article in newspaper.article_set.random3 %}
                <article class="flex h-full flex-col rounded-2xl border border-slate-200 bg-slate-50 p-4">
                    <div class="mb-4 overflow-hidden rounded-xl">
                        <img src="{% url 'geo_placeholder_svg' seed=article.pk %}" alt="{{ article.title }}" class="h-40 w-full object-cover">
                    </div>
                    <div class="flex-1">
                        <h4 class="text-lg font-semibold text-slate-900">
                            <a title="Go to full article page" href="{% url 'article_detail' article_id=article.pk %}" rel="noopener noreferrer" class="transition hover:text-brand-400">{{ article.title }}</a>
                        </h4>
                        <p class="mt-1 text-xs uppercase tracking-[0.2em] text-slate-500">{{ article.get_language_display }}</p>
                        {% if forloop.first %}
                        <p class="mt-3 text-sm text-slate-700" data-gender-annotations>{{ article.content|truncatewords:50 }}</p>
                        {% else %}
                        <p class="mt-3 text-sm text-slate-700" data-gender-annotations>{{ article.content|truncatewords:30 }}</p>
                        {% endif %}
                    </div>
                    <div class="mt-4 text-xs text-slate-600">
                        <span><i> By {{ article.author|truncatewords:2 }}</i>, </span>
                        <span>in <a href="{% url 'year_archive' year=article.published_year %}" class="text-slate-700 transition hover:text-brand-700">{{ article.published_year }}</a></span>
                        {% if article.link %}
                        <span> Â· <a class="text-slate-700 transition hover:text-brand-700" href="{{ article.link }}" target="_blank" rel="noopener noreferrer">ðŸ”— Source</a></span>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </section>
{% endblock main %}